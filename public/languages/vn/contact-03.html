<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Phan Ngô gia phả - Liên hệ</title>
    <link href="/css/default.css" rel="stylesheet" type="text/css" />
    <link href="/favicon.ico" rel="icon" type="image/x-icon" />
    <script src="/scripts/back_button.js"></script>
    <script src="/scripts/menu.js"></script>
    <script src="/scripts/search_person.js"></script>
    <!-- Thêm thư viện -->
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
      .contact-container {
        display: flex;
        flex-wrap: wrap;
        gap: 2rem;
        margin-top: 2rem;
      }
      .contact-info,
      .submission-form {
        flex: 1;
        min-width: 300px;
      }
      #submitForm {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
        margin-top: 1rem;
      }
      #submitForm label {
        font-weight: bold;
        margin-bottom: 0.5rem;
      }
      #submitForm input,
      #submitForm textarea,
      #submitForm select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      #submitForm textarea {
        min-height: 120px;
      }
      #submitForm button {
        background-color: #4caf50;
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        margin-top: 1rem;
      }
      #submitForm button:hover {
        background-color: #45a049;
      }
      .page_subsection {
        margin-bottom: 2rem;
        background: #f9f9f9;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body class="contact_page">
    <div id="view_id">
      <div id="header_id">
        <div id="header_inner_id">
          <div id="header_emblem_left_id">
            <img alt="" src="/resources/emblem.png" />
          </div>
          <div id="header_text_id">
            <h1>Phan Ngô gia phả</h1>
          </div>
        </div>
      </div>
      <div id="menu_id"></div>
      <div id="content_id">
        <div class="main_heading">
          <h1>Liên hệ</h1>
        </div>

        <div class="contact-container">
          <div class="contact-info">
            <div class="page_subsection">
              <h2>Liên hệ Tác giả</h2>
              <table>
                <tbody>
                  <tr>
                    <td>Tên:</td>
                    <td>Phan Trung Lâm</td>
                  </tr>
                  <tr>
                    <td>Địa chỉ:</td>
                    <td>Lake 2, Ecopark</td>
                  </tr>
                  <tr>
                    <td>Thành phố:</td>
                    <td>Bình Yên</td>
                  </tr>
                  <tr>
                    <td>Email:</td>
                    <td>
                      <a href="mailto:phantrunglam@gmail.com"
                        >phantrunglam@gmail.com</a
                      >
                    </td>
                  </tr>
                  <tr>
                    <td>Điện thoại:</td>
                    <td>+84 0989428555</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="page_subsection">
              <h2>Ban đại diện Gia tộc</h2>
              <table>
                <tbody>
                  <tr>
                    <td>Gia tộc:</td>
                    <td>Họ Phan Ngô Tống Văn</td>
                  </tr>
                  <tr>
                    <td>Website:</td>
                    <td>
                      <a href="https://phantrunglam.netlify.app" target="_blank"
                        >https://phantrunglam.netlify.app</a
                      >
                    </td>
                  </tr>
                  <tr>
                    <td>Phiên bản:</td>
                    <td>Phát hành 1.1</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="submission-form">
            <div class="page_subsection">
              <h2>Góp ý / Cập nhật</h2>
              <p>
                Quý thành viên có thể gửi thông tin, hình ảnh hoặc góp ý để cập
                nhật vào gia phả.
              </p>

              <form
                id="submitForm"
                method="POST"
                netlify
                enctype="multipart/form-data"
                data-netlify-recaptcha="true"
              >
                <!-- PHẦN NGƯỜI GỬI -->
                <div class="form-section">
                  <h3>Thông tin người gửi</h3>

                  <label>
                    Bạn là thành viên gia phả?
                    <select id="is_member">
                      <option value="0">Không</option>
                      <option value="1">Có</option>
                    </select>
                  </label>

                  <!-- Khối hiển thị khi chọn "Có" -->
                  <div id="member_info" style="display: none">
                    <label>
                      Tìm kiếm thành viên:
                      <input
                        type="text"
                        id="member_search"
                        placeholder="Nhập tên hoặc ID..."
                      />
                    </label>
                    <input type="hidden" id="member_id" name="member_id" />
                    <div id="member_details" class="member-card"></div>
                  </div>

                  <!-- Khối nhập thủ công -->
                  <div id="manual_info">
                    <label>
                      Họ Tên (*):
                      <input type="text" id="name" name="name" required />
                    </label>
                    <label>
                      Email:
                      <input type="email" id="email" name="email" />
                    </label>
                  </div>
                </div>

                <!-- PHẦN NỘI DUNG -->
                <div class="form-section">
                  <h3>Nội dung đóng góp</h3>
                  <!-- ... (giữ nguyên các trường comment, file upload) ... -->
                </div>

                <!-- PHẦN NGƯỜI LIÊN KẾT (Select2 như trước) -->
                <label>
                  Liên kết với nhân vật:
                  <select id="linked_to" name="linked_to" class="js-select2">
                    <option value="none">Chọn nhân vật...</option>
                  </select>
                </label>
              </form>
            </div>
          </div>
        </div>
      </div>
      <!--      script src="/scripts/submit-form.js"></script - -->

      <script>
        $(document).ready(function () {
          // ===== TẢI DỮ LIỆU TỪ JSON =====
          let allPersons = []; // Lưu trữ toàn bộ danh sách

          $.getJSON("/data/person_list.json")
            .done(function (persons) {
              allPersons = persons;

              // Khởi tạo Select2 cho người liên kết
              initSelect2("#linked_to", allPersons);

              // Khởi tạo tìm kiếm người gửi
              initMemberSearch();
            })
            .fail(handleLoadError);

          // ===== SELECT2 CHO NGƯỜI LIÊN KẾT =====
          function initSelect2(selector, data) {
            $(selector).select2({
              data: data.map(formatPersonOption),
              placeholder: "Tìm theo tên hoặc năm sinh...",
              width: "100%",
              templateResult: formatPersonDisplay,
              templateSelection: formatPersonDisplay,
            });
          }

          // ===== TÌM KIẾM NGƯỜI GỬI =====
          function initMemberSearch() {
            $("#is_member").change(function () {
              $("#member_info").toggle($(this).val() === "1");
              $("#manual_info").toggle($(this).val() === "0");
            });

            // Tự động hoàn thành
            $("#member_search")
              .autocomplete({
                source: function (request, response) {
                  const term = request.term.toLowerCase();
                  const results = allPersons
                    .filter(
                      (person) =>
                        person.person_name.toLowerCase().includes(term) ||
                        person.person_id.toLowerCase().includes(term)
                    )
                    .slice(0, 10); // Giới hạn 10 kết quả
                  response(results);
                },
                select: function (event, ui) {
                  displayMemberDetails(ui.item);
                  return false;
                },
              })
              .autocomplete("instance")._renderItem = function (ul, item) {
              return $("<li>")
                .append(
                  `<div>${item.person_name} <small>(${item.person_id})</small></div>`
                )
                .appendTo(ul);
            };
          }

          // ===== HIỂN THỊ THÔNG TIN NGƯỜI CHỌN =====
          function displayMemberDetails(person) {
            const details = `
      <h4>${person.person_name}</h4>
      <p>ID: ${person.person_id}</p>
      ${
        person.person_birthday
          ? `<p>Sinh năm: ${person.person_birthday}</p>`
          : ""
      }
      <button type="button" id="confirm_member">Xác nhận</button>
    `;

            $("#member_details")
              .html(details)
              .show()
              .off("click", "#confirm_member")
              .on("click", "#confirm_member", function () {
                $("#name").val(person.person_name);
                $("#member_id").val(person.person_id);
              });
          }

          // ===== ĐỊNH DẠNG HIỂN THỊ CHUNG =====
          function formatPersonOption(person) {
            return {
              id: person.person_id,
              text: `${person.person_name} (${person.person_id})`,
              person: person,
            };
          }

          function formatPersonDisplay(item) {
            if (!item.id) return item.text;
            const p = item.person || item;
            return $(`
      <div class="person-display">
        <span class="name">${p.person_name}</span>
        <span class="id">${p.person_id}</span>
        ${
          p.person_birthday
            ? `<span class="birth">${p.person_birthday}</span>`
            : ""
        }
      </div>
    `);
          }

          function handleLoadError() {
            alert("Không tải được danh sách thành viên. Vui lòng thử lại sau.");
          }
        });
      </script>

      <div id="footer_id">
        <div id="footer_text_id">
          <a href="https://phantrunglam.netlify.app"
            >Quản trị viên: Phan Trung Lâm, @Copyright 2025 Phan Ngô Đại tộc</a
          >
        </div>
      </div>
    </div>
  </body>
</html>
