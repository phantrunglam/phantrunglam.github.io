<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Phan Ngô gia phả - Liên hệ Góp ý</title>
    <link href="/css/default.css" rel="stylesheet" type="text/css" />
    <link href="/favicon.ico" rel="icon" type="image/x-icon" />
    <script src="/scripts/back_button.js"></script>
    <script src="/scripts/menu.js"></script>

    <!-- Thư viện -->
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/themes/base/jquery-ui.min.css"
      rel="stylesheet"
    />

    <style>
      body.contact_page {
        margin: 0;
        padding: 0;
        background: #f5f5f5;
      }

      #content_id {
        max-width: 100%;
        padding: 20px;
        box-sizing: border-box;
      }

      .fullscreen-form {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      }

      .sender-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .select2-container {
        width: 100% !important;
        margin: 5px 0 15px !important;
      }

      input[type="text"],
      input[type="email"] {
        width: 100%;
        padding: 8px;
        margin: 5px 0 15px;
        box-sizing: border-box;
      }

      .submit-btn {
        background: #4caf50;
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.3s;
        justify-self: end;
      }

      /* Hiển thị kết quả tìm kiếm */
      .person-option {
        padding: 8px;
      }
      .person-name {
        font-weight: bold;
        display: block;
      }
      .person-details {
        font-size: 0.9em;
        color: #666;
      }

      @media (max-width: 768px) {
        .sender-section {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body class="contact_page">
    <div id="view_id">
      <div id="header_id"></div>
      <div id="menu_id"></div>

      <div id="content_id">
        <div class="main_heading">
          <h1>Đóng góp thông tin gia phả</h1>
        </div>

        <form
          id="submitForm"
          class="fullscreen-form"
          method="POST"
          netlify
          enctype="multipart/form-data"
        >
          <!-- PHẦN NGƯỜI GỬI -->
          <div class="sender-section">
            <div class="member-info">
              <h3>Thông tin người gửi</h3>

              <label>Tìm kiếm thành viên:</label>
              <input
                type="text"
                id="member_search"
                placeholder="Nhập tên, năm sinh hoặc ID..."
              />
              <input type="hidden" id="member_id" name="member_id" />

              <label>Họ Tên (*):</label>
              <input type="text" id="name" name="name" required />

              <label>Email:</label>
              <input type="email" id="email" name="email" />
            </div>

            <!-- PHẦN LIÊN KẾT NHÂN VẬT -->
            <div class="linked-person">
              <h3>Liên kết với nhân vật</h3>
              <p>Nhập tên nhân vật cần cập nhật:</p>
              <input
                type="text"
                id="linked_to_search"
                placeholder="Tìm theo tên, năm sinh hoặc ID..."
              />
              <input type="hidden" id="linked_to" name="linked_to" />
            </div>
          </div>

          <!-- PHẦN NỘI DUNG -->
          <div class="content-section">
            <div class="comment-area">
              <h3>Nội dung đóng góp</h3>
              <textarea
                id="comment"
                name="comment"
                placeholder="Mô tả chi tiết thông tin bạn muốn cập nhật..."
                required
                style="width: 100%; min-height: 200px; padding: 15px"
              ></textarea>
            </div>

            <button type="submit" class="submit-btn">Gửi thông tin</button>
          </div>
        </form>
      </div>

      <div id="footer_id"></div>
    </div>

    <!-- Script -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
      $(document).ready(function () {
        let allPersons = [];
        const jsonPath = "/scripts/person_list.json"; // Đường dẫn đến file JSON

        // 1. Tải dữ liệu từ file JSON
        function loadPersonData() {
          $.getJSON(jsonPath)
            .done(function (data) {
              allPersons = data;
              initSearchFields();
            })
            .fail(function () {
              alert(
                "Không tải được danh sách thành viên. Vui lòng tải lại trang."
              );
            });
        }

        // 2. Định dạng hiển thị
        function formatPerson(person) {
          if (!person.id) return person.text;

          let displayText = person.person_name || person.text;
          if (person.person_birthday) {
            displayText += ` • ${person.person_birthday}`;
          }
          if (person.person_id) {
            displayText += ` • ID: ${person.person_id}`;
          }
          return displayText;
        }

        // 3. Khởi tạo các ô tìm kiếm
        function initSearchFields() {
          // Cấu hình chung cho Select2
          const select2Config = {
            data: allPersons.map((person) => ({
              id: person.person_id,
              text: person.person_name,
              person_name: person.person_name,
              person_birthday: person.person_birthday,
              person_id: person.person_id,
            })),
            placeholder: "Nhập tên, năm sinh hoặc ID...",
            minimumInputLength: 1,
            width: "100%",
            matcher: function (params, data) {
              // Cho phép tìm kiếm theo tên, năm sinh hoặc ID
              const term = params.term.toLowerCase();
              const nameMatch =
                data.person_name?.toLowerCase().includes(term) || false;
              const birthMatch = data.person_birthday?.includes(term) || false;
              const idMatch =
                data.person_id?.toLowerCase().includes(term) || false;

              return nameMatch || birthMatch || idMatch;
            },
            templateResult: function (data) {
              return formatPerson(data);
            },
            templateSelection: function (data) {
              return formatPerson(data);
            },
          };

          // Ô tìm kiếm người gửi
          $("#member_search")
            .select2(select2Config)
            .on("select2:select", function (e) {
              const person = e.params.data;
              $("#name").val(person.person_name);
              $("#member_id").val(person.id);
            });

          // Ô tìm kiếm người liên kết
          $("#linked_to_search")
            .select2(select2Config)
            .on("select2:select", function (e) {
              $("#linked_to").val(e.params.data.id);
            });
        }

        // Khởi chạy
        loadPersonData();
      });
    </script>
  </body>
</html>
