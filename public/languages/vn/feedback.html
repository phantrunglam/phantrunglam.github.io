<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Phan Ngô gia phả - Liên hệ Góp ý</title>
    <link href="/css/default.css" rel="stylesheet" type="text/css" />
    <link href="/favicon.ico" rel="icon" type="image/x-icon" />
    <script src="/scripts/back_button.js"></script>
    <script src="/scripts/menu.js"></script>

    <!-- Thư viện -->
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/themes/base/jquery-ui.min.css"
      rel="stylesheet"
    />

    <style>
      body.contact_page {
        margin: 0;
        padding: 0;
        background: #f5f5f5;
      }

      #content_id {
        max-width: 100%;
        padding: 20px;
        box-sizing: border-box;
      }

      .fullscreen-form {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      }

      .sender-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .select2-container {
        width: 100% !important;
        margin: 5px 0 15px !important;
      }

      input[type="text"],
      input[type="email"] {
        width: 100%;
        padding: 8px;
        margin: 5px 0 15px;
        box-sizing: border-box;
      }

      .submit-btn {
        background: #4caf50;
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.3s;
        justify-self: end;
      }

      /* Hiển thị kết quả tìm kiếm */
      .person-option {
        padding: 8px;
      }
      .person-name {
        font-weight: bold;
        display: block;
      }
      .person-details {
        font-size: 0.9em;
        color: #666;
      }

      @media (max-width: 768px) {
        .sender-section {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body class="contact_page">
    <div id="view_id">
      <div id="header_id"></div>
      <div id="menu_id"></div>

      <div id="content_id">
        <div class="main_heading">
          <h1>Đóng góp thông tin gia phả</h1>
        </div>

        <form
          id="submitForm"
          class="fullscreen-form"
          method="POST"
          netlify
          enctype="multipart/form-data"
        >
          <!-- PHẦN NGƯỜI GỬI -->
          <div class="sender-section">
            <div class="member-info">
              <h3>Thông tin người gửi</h3>

              <label>Tìm kiếm thành viên:</label>
              <input
                type="text"
                id="member_search"
                placeholder="Nhập tên, năm sinh hoặc ID..."
              />
              <input type="hidden" id="member_id" name="member_id" />

              <label>Họ Tên (*):</label>
              <input type="text" id="name" name="name" required />

              <label>Email:</label>
              <input type="email" id="email" name="email" />
            </div>

            <!-- PHẦN LIÊN KẾT NHÂN VẬT -->
            <div class="linked-person">
              <h3>Liên kết với nhân vật</h3>
              <p>Nhập tên nhân vật cần cập nhật:</p>
              <input
                type="text"
                id="linked_to_search"
                placeholder="Tìm theo tên, năm sinh hoặc ID..."
              />
              <input type="hidden" id="linked_to" name="linked_to" />
            </div>
          </div>

          <!-- PHẦN NỘI DUNG -->
          <div class="content-section">
            <div class="comment-area">
              <h3>Nội dung đóng góp</h3>
              <textarea
                id="comment"
                name="comment"
                placeholder="Mô tả chi tiết thông tin bạn muốn cập nhật..."
                required
                style="width: 100%; min-height: 200px; padding: 15px"
              ></textarea>
            </div>

            <button type="submit" class="submit-btn">Gửi thông tin</button>
          </div>
        </form>
      </div>

      <div id="footer_id"></div>
    </div>

    <!-- Script -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
      $(document).ready(function () {
        // Hàm định dạng hiển thị
        function formatPerson(person) {
          if (!person.id) return person.text;

          let displayText = `<div class="person-option">
                              <span class="person-name">${
                                person.person_name || person.text
                              }</span>`;

          if (person.person_birthday) {
            displayText += `<span class="person-details"> • ${person.person_birthday}</span>`;
          }
          if (person.person_id) {
            displayText += `<span class="person-details"> • ID: ${person.person_id}</span>`;
          }

          return displayText + "</div>";
        }

        // Cấu hình chung cho Select2
        const select2Config = {
          placeholder: "Nhập ít nhất 1 ký tự...",
          minimumInputLength: 1,
          width: "100%",
          ajax: {
            url: "/api/search_member",
            dataType: "json",
            delay: 250,
            data: function (params) {
              return { q: params.term };
            },
            processResults: function (data) {
              return {
                results: data.items.map((item) => ({
                  id: item.person_id,
                  text: item.person_name,
                  person_name: item.person_name,
                  person_birthday: item.person_birthday,
                  person_id: item.person_id,
                })),
              };
            },
          },
          templateResult: formatPerson,
          templateSelection: formatPerson,
          escapeMarkup: function (m) {
            return m;
          },
        };

        // Khởi tạo ô tìm kiếm người gửi
        $("#member_search")
          .select2(select2Config)
          .on("select2:select", function (e) {
            const person = e.params.data;
            $("#name").val(person.person_name);
            $("#member_id").val(person.id);
          });

        // Khởi tạo ô tìm kiếm người liên kết
        $("#linked_to_search")
          .select2(select2Config)
          .on("select2:select", function (e) {
            $("#linked_to").val(e.params.data.id);
          });
      });
    </script>
  </body>
</html>
